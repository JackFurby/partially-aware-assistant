{% extends "template_parts/base.html" %}

{% block content %}
<main class="flex-1 p-4 sm:p-6 lg:p-8 mt-4">
	<div class="bg-white p-6 rounded shadow">
		<div class="flex justify-between flex-wrap items-center pb-3">
			<h1 class="text-2xl font-semibold text-gray-900">Chat</h1>
			<a href="{{ url_for('agent.chat') }}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">New Chat</a>
		</div>
		<hr class="my-4 border-gray-300"/>

		<!-- Messages will appear here -->
		<div id="chat-window" class="flex-1 overflow-y-auto mb-4 p-4 space-y-2 border rounded bg-gray-50">
			{% for m in messages %}
				{% if m.role == "user" %}
					<div class="flex justify-end">
						<div class="bg-blue-600 text-white p-2 rounded-lg max-w-xs break-words">
							{{ m.message }}
						</div>
					</div>
				{% elif m.role == "assistant" %}
					<div class="flex justify-start">
						<div class="bg-gray-200 text-gray-900 p-2 rounded-lg max-w-xs break-words">
							{{ m.message }}
						</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>

		<form id="chat-form" class="space-y-6">
			{{ form.hidden_tag() }}

			<div>
				<label class="block text-sm font-medium text-gray-700 mb-1">
					{{ form.message.label.text }}
				</label>
				{{ form.message(rows="4", class_="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
			</div>

			<div class="flex flex-wrap items-end gap-4">

				<div class="flex-1 min-w-[160px]">
					<label class="block text-sm font-medium text-gray-700 mb-1">
						{{ form.agent_id.label.text }}
					</label>
						{{ form.agent_id(id="agent", class_="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" ) }}
					</div>

				<div class="flex-1 min-w-[160px]">
					<label class="block text-sm font-medium text-gray-700 mb-1">
						{{ form.model_name.label.text }}
					</label>
					{{ form.model_name(id="model", class_="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
				</div>

				<div class="flex items-end">
					{{ form.submit(class_="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700") }}
				</div>
			</div>
		</form>

	</div>
</main>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const agentSelect = document.getElementById("agent");
    const modelSelect = document.getElementById("model");
    const chatForm = document.getElementById("chat-form");
    const chatWindow = document.getElementById("chat-window");

    // Populate models when agent changes
    agentSelect.addEventListener("change", function () {
        const agentId = this.value;
        fetch(`/chat/models/${agentId}`)
            .then(response => response.json())
            .then(data => {
                modelSelect.innerHTML = "";
                const placeholder = document.createElement("option");
                placeholder.text = "Select a model";
                placeholder.disabled = true;
                placeholder.selected = true;
                modelSelect.appendChild(placeholder);

                data.forEach(name => {
                    const option = document.createElement("option");
                    option.value = name;
                    option.text = name;
                    modelSelect.appendChild(option);
                });
            });
    });

		chatForm.addEventListener("submit", async function(e) {
    e.preventDefault();

    const formData = new FormData(chatForm);
    const message = formData.get("message");
    const agentId = formData.get("agent_id");
    const modelName = formData.get("model_name");

    if (!message || !agentId || !modelName) return;

    // Append user message to chat window
    const userMsg = document.createElement("div");
    userMsg.className = "flex justify-end";
    userMsg.innerHTML = `<div class="bg-blue-600 text-white p-2 rounded-lg max-w-xs break-words">${message}</div>`;
    chatWindow.appendChild(userMsg);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // Prepare agent message container
    const agentMsg = document.createElement("div");
    agentMsg.className = "flex justify-start";
    const bubble = document.createElement("div");
    bubble.className = "bg-gray-200 text-gray-900 p-2 rounded-lg max-w-xs break-words cursor-pointer";
    agentMsg.appendChild(bubble);
    chatWindow.appendChild(agentMsg);

    let metadata = [];
    let buffer = "";

    // Streaming fetch
    const response = await fetch("/chat/send_message", { method: "POST", body: formData });
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        // Split by newline (NDJSON) for safe JSON parsing
        const lines = buffer.split("\n");
        buffer = lines.pop(); // last incomplete line

        for (let line of lines) {
            if (!line.trim()) continue;
            try {
                const obj = JSON.parse(line);
                if (obj.message && obj.message.content) {
                    bubble.textContent += obj.message.content;
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
                metadata.push(obj);
            } catch (err) {
                console.error("Failed to parse chunk:", line, err);
            }
        }
    }

    // Handle any remaining buffer
    if (buffer.trim()) {
        try {
            const obj = JSON.parse(buffer);
            if (obj.message && obj.message.content) {
                bubble.textContent += obj.message.content;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            metadata.push(obj);
        } catch (err) {
            metadata.push({ raw: buffer });
        }
    }

    // Attach click handler for metadata display
    bubble.addEventListener("click", () => {
        alert("Message metadata:\n" + JSON.stringify(metadata, null, 2));
    });

    // Save assistant message to session via a separate POST request
    await fetch("/chat/save_message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: bubble.textContent })
    });

    // Clear input field
    chatForm.message.value = "";
});


});
</script>

{% endblock %}
