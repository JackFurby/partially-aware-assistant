{% extends "template_parts/base.html" %}

{% block content %}
<main class="flex-1 p-4 sm:p-6 lg:p-8 mt-4">
	<div class="bg-white p-6 rounded shadow">
		<div class="flex justify-between flex-wrap items-center pb-3">
			<h1 class="text-2xl font-semibold text-gray-900">Settings</h1>
		</div>
		<hr class="my-4 border-gray-300"/>

		<div class="p-4 rounded-lg bg-gray-50 bg-gray-800" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
							<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						{% for model in models %}
						<tr>
							<td class="px-4 py-2 whitespace-nowrap">{{ model.model_name }}</td>
							<td class="px-4 py-2 whitespace-nowrap">
								<button data-agent="{{ model.agent_id }}" data-model="{{ model.model_name }}" class="pull-btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
									Pull Model
								</button>

								<form method="POST" class="flex items-center gap-2 mt-2" action="{{ url_for('settings.add_model_tag', id=model.agent_id) }}">
									{{ tag_form.hidden_tag() }}

									{{ tag_form.model_name(value=model.model_name, type="hidden") }}

									{{ tag_form.tags(class="block w-48 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500") }}

									{{ tag_form.submit(class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500") }}
								</form>

								<div class="flex flex-wrap gap-1 mt-1">
									{% for tag in model.tags %}
										<span class="bg-gray-200 text-xs px-2 py-0.5 rounded">
											{{ tag.name }}
										</span>
									{% endfor %}
								</div>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		<form method="POST" class="space-y-4">
			{{ model_form.hidden_tag() }}

			<div>
				{{ model_form.name.label(class="block text-gray-700 font-medium mb-1") }}
				{{ model_form.name(class="block w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500") }}
				{% for error in model_form.name.errors %}
					<p class="text-sm text-red-600 mt-1">{{ error }}</p>
				{% endfor %}
			</div>

			<div>
				<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
					{{ model_form.submit.label.text }}
				</button>
			</div>
		</form>

		<pre id="output" style="height:300px; overflow-y:auto; background:#111; color:#0f0; padding:10px;"></pre>

	</div>
</main>

<script>
	document.querySelectorAll(".pull-btn").forEach(btn => {
		btn.addEventListener("click", () => {
			const agentId = btn.dataset.agent;
			const modelName = btn.dataset.model;
			const output = document.getElementById("output");

			output.textContent = `Starting pull: ${modelName}\n`;

			const url = `/settings/stream_pull/${agentId}/${modelName}`;
			const stream = new EventSource(url);

			stream.onmessage = (e) => {
				output.textContent += e.data + "\n";
				output.scrollTop = output.scrollHeight;
			};

			stream.onerror = () => {
				output.textContent += "\n[stream closed]\n";
				stream.close();
			};
		});
	});
</script>

{% endblock %}
